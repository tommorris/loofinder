<!DOCTYPE html>
<html>
  <head>
    <title>Loofinder test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Leaflet -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

    <!-- Nice markers with different colours and icons, see https://github.com/lvoogdt/Leaflet.awesome-markers -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <style>
      body {
      padding: 0;
      margin: 0;
      }
      
      html, body, #map {
      height: 100%;
      }
    </style>
  </head>
  
  <body>
    <div id="map"></div>
    
    <script>
      var map = L.map('map');

    if (window.devicePixelRatio > 1) {
        var infix = "lr";
      } else {
        var infix = "ls";
      }
      var tileurl = 'http://tiles.lyrk.org/' + infix + '/{z}/{x}/{y}?apikey=c6e69d73e27c4b94b9e5722d701046db';
      var osmAttrib='Map data Â© OpenStreetMap contributors';
      L.tileLayer(tileurl, {
      maxZoom: 18,
      attribution: osmAttrib
      }).addTo(map);
      
      function onLocationFound(e) {
      var radius = e.accuracy / 2;

      //L.marker(e.latlng).addTo(map).bindPopup("You are within " + radius + " meters from this point").openPopup();
      L.circle(e.latlng, radius).addTo(map);
      }

      function onLocationError(e) {
      alert(e.message);
      }

      map.on('locationfound', onLocationFound);
      map.on('locationerror', onLocationError);
      map.locate({setView: true, maxZoom: 16});

      // Set the proper prefix for FontAwesome
      L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';

      // Create custom markers
      var redMarker = L.AwesomeMarkers.icon({
      icon: 'thumbs-down',
      markerColor: 'red'
      });
      var greenMarker = L.AwesomeMarkers.icon({
      icon: 'thumbs-up',
      markerColor: 'green'
      });
      var grayMarker = L.AwesomeMarkers.icon({
      icon: 'question-circle',
      markerColor: 'gray'
      });

    var getJSON = function(url, successHandler, errorHandler) {
        var xhr = typeof XMLHttpRequest != 'undefined'
            ? new XMLHttpRequest()
            : new ActiveXObject('Microsoft.XMLHTTP');
          xhr.open('get', url, true);
          xhr.onreadystatechange = function() {
            var status;
            var data;
            // https://xhr.spec.whatwg.org/#dom-xmlhttprequest-readystate
            if (xhr.readyState == 4) { // `DONE`
              status = xhr.status;
              if (status == 200) {
                data = JSON.parse(xhr.responseText);
                successHandler && successHandler(data);
              } else {
                errorHandler && errorHandler(status);
              }
            }
          };
          xhr.send();
        };

    getJSON('/search', function(data) {
      var myLayer = L.geoJson(data,
        {
            pointToLayer: function(feature, latlng) {
                var chosen_col = grayMarker;
                if (feature.properties.unisex == true) {
                    var chosen_col = greenMarker;
                }
                if (feature.properties.unisex == false) {
                    var chosen_col = redMarker;
                }
                return L.marker(latlng, {icon: chosen_col});
            },
        }
      ).addTo(map);

    });
    </script>
  </body>
</html>

